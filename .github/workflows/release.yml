name: Release

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        type: string

jobs:
  release:
    name: Create Release
    runs-on: macos-latest

    steps:
    - name: Determine ref to checkout
      id: ref
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ref=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
        else
          echo "ref=${GITHUB_REF}" >> $GITHUB_OUTPUT
        fi

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.ref.outputs.ref }}
        fetch-depth: 0

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/.cache/org.swift.swiftpm
        key: ${{ runner.os }}-spm-release-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-release-
          ${{ runner.os }}-spm-

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi

        COMMIT_SHA=$(git rev-parse HEAD)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        echo "Commit SHA: $COMMIT_SHA"

    - name: Build
      run: swift build -c release

    - name: Run tests
      run: swift test

    - name: Generate Release Notes
      id: release_notes
      run: |
        BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

        cat > release_notes.md << EOF
        ## 📦 MicroContainer ${{ steps.version.outputs.version }}

        MicroContainer is a tiny, dependency-free Swift dependency injection container.

        ### 📋 Requirements

        - **macOS**: 10.15+
        - **iOS**: 13.0+
        - **Swift Tools**: 5.9+

        ### 📚 Installation

        #### Swift Package Manager

        Add MicroContainer to your `Package.swift`:

        ```swift
        dependencies: [
            .package(url: "https://github.com/otaviocc/MicroContainer.git", from: "${{ steps.version.outputs.version }}")
        ]
        ```

        Or add it via Xcode:
        1. File → Add Package Dependencies
        2. Enter: `https://github.com/otaviocc/MicroContainer.git`
        3. Select version: `${{ steps.version.outputs.version }}`

        ### 🚀 Quick Start

        ```swift
        import MicroContainer

        let container = DependencyContainer()
        container.registerSingleton(ServiceProtocol.self) { _ in Service() }
        let service: ServiceProtocol = container.resolve()
        ```

        ### 📊 Build Information

        - **Build Date**: $BUILD_DATE
        - **Commit**: ${{ steps.version.outputs.commit_sha }}
        - **Swift Tools Version**: 5.9

        ### 🔍 Features

        - ✅ **Minimal API**: register/resolve with lifetimes
        - ✅ **Thread-safe**: synchronized registration and resolution
        - ✅ **Qualifiers**: named registrations
        - ✅ **Safer resolves**: optional and throwing variants
        - ✅ **Circular detection**: detects circular graphs

        EOF

        echo "Generated release notes"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "MicroContainer ${{ steps.version.outputs.version }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Release Notes Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-notes-${{ steps.version.outputs.version }}
        path: release_notes.md
        retention-days: 90
